<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Moon Phases Demo | AstroEd</title>
  <link rel="icon" type="image/svg+xml" href="../_assets/favicon.svg">
  <link rel="stylesheet" href="../_assets/astro-theme.css">
  <link rel="stylesheet" href="../_assets/demo-shell.css">
  <link rel="stylesheet" href="../_assets/demo-legacy.css">
  <style>
    :root {
      --demo-max-width: 1000px;
    }

    /* Two-panel layout */
    .viz-layout {
      display: grid;
      grid-template-columns: 1.5fr 1fr;
      margin-bottom: var(--space-md);
    }

    #orbital-svg, #phase-svg {
      width: 100%;
      height: auto;
      display: block;
    }

    /* Readouts */
    .readout-panel {
      grid-template-columns: repeat(3, 1fr);
    }

    /* Controls */
    .controls-panel {
      background: rgba(18, 18, 31, 0.9);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
    }

    .controls-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      justify-content: center;
    }

    /* Key insight */
    .insight-box {
      background: rgba(18, 18, 31, 0.9);
      border-left: 3px solid var(--accent-green);
      padding: 1rem;
      border-radius: 0 8px 8px 0;
      font-size: 0.9rem;
    }

    .insight-box strong {
      color: var(--accent-green);
    }

    .model-note {
      margin-top: var(--space-md);
      background: rgba(18, 18, 31, 0.9);
      border: 1px solid var(--border-color);
      border-left: 3px solid var(--accent-gold);
      padding: 0.75rem 1rem;
      border-radius: 0 8px 8px 0;
      font-size: var(--font-size-sm);
      color: var(--text-secondary);
    }

    .model-note strong {
      color: var(--text-primary);
    }

    /* Draggable hint */
    .drag-hint {
      text-align: center;
      color: var(--text-muted);
      font-size: 0.75rem;
      margin-top: 0.5rem;
    }

    .schematic-note {
      text-align: center;
      color: var(--text-muted);
      font-size: var(--font-size-xs);
      margin-top: var(--space-xs);
    }

    /* Moon in SVG */
    .moon-draggable {
      cursor: grab;
    }

    .moon-draggable:active {
      cursor: grabbing;
    }

    /* Responsive */
    @media (max-width: 700px) {
      .viz-layout {
        grid-template-columns: 1fr;
      }

      .readout-panel {
        grid-template-columns: 1fr;
      }
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    /* Timeline Strip */
    .timeline-panel {
      background: rgba(18, 18, 31, 0.9);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
    }

    .timeline-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.75rem;
      font-size: 0.875rem;
    }

    .timeline-direction {
      color: var(--accent-gold);
      font-weight: 600;
    }

    .timeline-direction.waning {
      color: var(--accent-blue);
    }

    .timeline-day {
      color: var(--text-secondary);
      font-family: var(--font-mono);
    }

    .timeline-strip {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.25rem;
    }

    .timeline-phase {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.25rem;
      padding: 0.5rem;
      background: transparent;
      border: 2px solid transparent;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      flex: 1;
      min-width: 0;
    }

    .timeline-phase:hover {
      background: rgba(93, 173, 226, 0.1);
      border-color: var(--accent-blue);
    }

    .timeline-phase.active {
      background: rgba(244, 208, 63, 0.2);
      border-color: var(--accent-gold);
    }

    .timeline-phase span {
      font-size: 0.65rem;
      color: var(--text-muted);
      white-space: nowrap;
    }

    .timeline-phase.active span {
      color: var(--accent-gold);
    }

    /* Phase icons */
    .phase-icon {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      position: relative;
      background: var(--moon-dark);
      overflow: hidden;
    }

    .phase-icon::after {
      content: '';
      position: absolute;
      top: 0;
      width: 50%;
      height: 100%;
      background: var(--moon-light);
    }

    .phase-icon.new-moon::after { display: none; }
    .phase-icon.full-moon::after { width: 100%; left: 0; border-radius: 50%; }
    .phase-icon.first-quarter::after { left: 50%; }
    .phase-icon.third-quarter::after { left: 0; }
    .phase-icon.waxing-crescent::after { left: 50%; width: 25%; border-radius: 0 50% 50% 0; }
    .phase-icon.waning-crescent::after { left: 25%; width: 25%; border-radius: 50% 0 0 50%; }
    .phase-icon.waxing-gibbous::after { left: 25%; width: 75%; border-radius: 50% 50% 50% 50%; }
    .phase-icon.waning-gibbous::after { left: 0; width: 75%; border-radius: 50% 50% 50% 50%; }

    @media (max-width: 600px) {
      .timeline-phase span { display: none; }
      .phase-icon { width: 24px; height: 24px; }
    }

    /* Animation Controls */
    .animation-controls {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 1rem;
      background: rgba(18, 18, 31, 0.9);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }

    .anim-btn {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.5rem 0.75rem;
      background: var(--space-light);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 0.875rem;
      transition: all 0.15s ease;
    }

    .anim-btn:hover:not(:disabled) {
      background: var(--space-medium);
      color: var(--text-primary);
      border-color: var(--accent-blue);
    }

    .anim-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .anim-btn.primary {
      background: var(--accent-blue);
      color: var(--space-black);
      border-color: var(--accent-blue);
    }

    .anim-btn.primary:hover:not(:disabled) {
      background: var(--ice-blue);
    }

    .btn-icon {
      font-size: 0.75rem;
    }

    .speed-control {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-left: auto;
      font-size: 0.875rem;
      color: var(--text-secondary);
    }

    .speed-control select {
      padding: 0.25rem 0.5rem;
      background: var(--space-light);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      color: var(--text-primary);
      cursor: pointer;
    }

    /* Insight popup animation */
    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateX(-50%) translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    }

    .shadow-insight-popup {
      position: fixed;
      bottom: 2rem;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(18, 18, 31, 0.95);
      border: 1px solid var(--border-color);
      border-left: 3px solid var(--accent-green);
      color: var(--text-primary);
      padding: 1rem 1.25rem;
      border-radius: 12px;
      max-width: 420px;
      z-index: 1000;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      animation: slideUp 0.3s ease-out;
    }

    .insight-popup-content {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .insight-popup-content strong {
      color: var(--accent-green);
    }

    .insight-close {
      align-self: flex-end;
      background: var(--accent-green);
      color: var(--space-black);
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.875rem;
    }

    .insight-close:hover {
      filter: brightness(1.05);
    }

    .insight-close:focus-visible {
      outline: 2px solid var(--accent-blue);
      outline-offset: 2px;
    }
  </style>
</head>
<body>
  <div class="demo-wrapper">
    <canvas id="starfield"></canvas>

    <div class="demo-content">
      <header class="demo-header">
        <h1 class="demo-title">Moon Phases</h1>
        <p class="demo-subtitle">The phase shows how much of the lit half we see from Earth</p>
      </header>

      <!-- Challenge mode container (populated by JS) -->
      <div id="challenge-container"></div>

      <!-- Two-panel visualization -->
      <div class="viz-layout">
        <!-- Orbital view -->
        <div class="viz-panel">
          <div class="panel-title">View from Above (North Pole)</div>
          <svg id="orbital-svg" viewBox="0 0 400 400" preserveAspectRatio="xMidYMid meet">
            <defs>
              <!-- Sun glow -->
              <radialGradient id="sunGlow" cx="50%" cy="50%" r="50%">
                <stop offset="0%" stop-color="var(--sun-core)"/>
                <stop offset="60%" stop-color="var(--sun-glow)"/>
                <stop offset="100%" stop-color="var(--sun-corona)"/>
              </radialGradient>

              <!-- Earth gradient -->
              <radialGradient id="earthGradient" cx="30%" cy="30%">
                <stop offset="0%" stop-color="var(--earth-blue)"/>
                <stop offset="100%" stop-color="var(--text-muted)"/>
              </radialGradient>

              <!-- Moon lit side -->
              <radialGradient id="moonLit" cx="30%" cy="30%">
                <stop offset="0%" stop-color="var(--moon-light)"/>
                <stop offset="100%" stop-color="var(--text-secondary)"/>
              </radialGradient>

              <!-- Clip for moon phases -->
              <clipPath id="moonClip">
                <circle cx="0" cy="0" r="15"/>
              </clipPath>
            </defs>

            <!-- Sunlight arrows -->
            <g id="sunlight-arrows" opacity="0.4">
              <line x1="0" y1="100" x2="80" y2="100" stroke="var(--sun-glow)" stroke-width="2" marker-end="url(#arrowhead)"/>
              <line x1="0" y1="200" x2="80" y2="200" stroke="var(--sun-glow)" stroke-width="2"/>
              <line x1="0" y1="300" x2="80" y2="300" stroke="var(--sun-glow)" stroke-width="2"/>
              <text x="10" y="60" fill="var(--sun-glow)" font-size="11">Sunlight</text>
            </g>

            <!-- Sun (off-screen left, show edge) -->
            <circle cx="-60" cy="200" r="80" fill="url(#sunGlow)" opacity="0.8"/>

            <!-- Moon's orbit -->
            <circle cx="200" cy="200" r="120" fill="none" stroke="var(--text-muted)" stroke-width="1" stroke-dasharray="4 4" opacity="0.6"/>

            <!-- Earth -->
            <g id="earth-group" transform="translate(200, 200)">
              <circle r="25" fill="url(#earthGradient)" filter="url(#glow)"/>
              <text y="45" text-anchor="middle" fill="var(--text-secondary)" font-size="11">Earth</text>
            </g>

            <!-- Earth's Shadow Cone (toggled by checkbox) -->
            <g id="earth-shadow-group" style="display: none;">
              <!-- Shadow cone extending opposite to Sun (rightward) -->
              <defs>
                <linearGradient id="shadowGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                  <stop offset="0%" stop-color="rgba(30, 30, 50, 0.6)"/>
                  <stop offset="100%" stop-color="rgba(30, 30, 50, 0)"/>
                </linearGradient>
              </defs>
              <!-- Umbra cone (darker, narrower) -->
              <path id="umbra-cone"
                    d="M 225 200 L 380 185 L 380 215 Z"
                    fill="rgba(20, 20, 40, 0.5)"
                    stroke="none"/>
              <!-- Penumbra cone (lighter, wider) -->
              <path id="penumbra-cone"
                    d="M 225 200 L 400 160 L 400 240 Z"
                    fill="url(#shadowGradient)"
                    stroke="rgba(100, 100, 140, 0.3)"
                    stroke-width="1"
                    stroke-dasharray="4 2"/>
              <!-- Label -->
              <text x="320" y="155" fill="var(--accent-red)" font-size="10" opacity="0.8">Earth's Shadow</text>
              <text x="300" y="168" fill="var(--accent-red)" font-size="9" opacity="0.6">(only matters for eclipses!)</text>
            </g>

            <!-- Moon (draggable) -->
            <g id="moon-group" class="moon-draggable"
               role="slider"
               aria-label="Moon position on orbit"
               aria-valuemin="0"
               aria-valuemax="360"
               aria-valuenow="0"
               aria-valuetext="Full Moon, 100% illuminated"
              tabindex="0">
              <!-- Dark side (always visible as background) -->
              <circle id="moon-dark" cx="320" cy="200" r="15" fill="var(--moon-dark)"/>
              <!-- Lit side (clipped to show phase in orbital view) -->
              <circle id="moon-lit" cx="320" cy="200" r="15" fill="url(#moonLit)"/>
              <!-- Terminator line (boundary between lit and dark) -->
              <ellipse id="moon-terminator" cx="320" cy="200" rx="0" ry="15" fill="var(--moon-dark)"/>
            </g>

            <!-- Observer's view direction indicator -->
            <g id="view-indicator" opacity="0.5">
              <path d="M 200 175 L 200 140" stroke="var(--ice-blue)" stroke-width="1" stroke-dasharray="3 3"/>
              <text x="200" y="130" text-anchor="middle" fill="var(--ice-blue)" font-size="9">Your view</text>
            </g>
          </svg>
          <div class="drag-hint">Drag the Moon around Earth's orbit</div>
        </div>

        <!-- Phase view (as seen from Earth) -->
        <div class="viz-panel">
          <div class="panel-title">As Seen from Earth</div>
          <svg id="phase-svg" viewBox="0 0 200 200" preserveAspectRatio="xMidYMid meet">
            <defs>
              <radialGradient id="moonSurface" cx="30%" cy="30%">
                <stop offset="0%" stop-color="var(--moon-light)"/>
                <stop offset="100%" stop-color="var(--text-secondary)"/>
              </radialGradient>

              <!-- Earthshine (faint illumination of dark side) -->
              <radialGradient id="earthshine" cx="70%" cy="30%">
                <stop offset="0%" stop-color="var(--space-light)"/>
                <stop offset="100%" stop-color="var(--space-medium)"/>
              </radialGradient>
            </defs>

            <!-- Moon disk -->
            <g transform="translate(100, 100)">
              <!-- Dark side with earthshine -->
              <circle r="60" fill="url(#earthshine)"/>

              <!-- Lit portion (will be updated by JS) -->
              <path id="lit-portion" d="" fill="url(#moonSurface)"/>
            </g>
          </svg>
          <div class="schematic-note">Schematic (not to scale).</div>
        </div>
      </div>

      <!-- Readouts -->
      <div class="readout-panel">
        <div class="readout-item">
          <div class="readout-label">Phase</div>
          <div class="readout-value phase-name" id="phase-name">Full Moon</div>
        </div>
        <div class="readout-item">
          <div class="readout-label">Illumination</div>
          <div class="readout-value" id="illumination">100%</div>
        </div>
        <div class="readout-item">
          <div class="readout-label">Days Since New Moon</div>
          <div class="readout-value" id="days-since-new">14.8</div>
        </div>
      </div>

      <!-- Phase Timeline -->
      <div class="timeline-panel">
        <div class="timeline-header">
          <span class="timeline-direction" id="timeline-direction">WAXING →</span>
          <span class="timeline-day" id="timeline-day">Day 0 of 29.5</span>
        </div>
        <div class="timeline-strip" id="timeline-strip">
          <button class="timeline-phase" data-angle="180" title="New Moon">
            <div class="phase-icon new-moon"></div>
            <span>New</span>
          </button>
          <button class="timeline-phase" data-angle="225" title="Waxing Crescent">
            <div class="phase-icon waxing-crescent"></div>
            <span>Crescent</span>
          </button>
          <button class="timeline-phase" data-angle="270" title="First Quarter">
            <div class="phase-icon first-quarter"></div>
            <span>1st Qtr</span>
          </button>
          <button class="timeline-phase" data-angle="315" title="Waxing Gibbous">
            <div class="phase-icon waxing-gibbous"></div>
            <span>Gibbous</span>
          </button>
          <button class="timeline-phase" data-angle="0" title="Full Moon">
            <div class="phase-icon full-moon"></div>
            <span>Full</span>
          </button>
          <button class="timeline-phase" data-angle="45" title="Waning Gibbous">
            <div class="phase-icon waning-gibbous"></div>
            <span>Gibbous</span>
          </button>
          <button class="timeline-phase" data-angle="90" title="Third Quarter">
            <div class="phase-icon third-quarter"></div>
            <span>3rd Qtr</span>
          </button>
          <button class="timeline-phase" data-angle="135" title="Waning Crescent">
            <div class="phase-icon waning-crescent"></div>
            <span>Crescent</span>
          </button>
        </div>
      </div>

      <!-- Animation Controls -->
      <div class="animation-controls">
        <button class="anim-btn primary" id="btn-play">
          <span class="btn-icon">▶</span> Play
        </button>
        <button class="anim-btn" id="btn-pause" disabled>
          <span class="btn-icon">⏸</span> Pause
        </button>
        <button class="anim-btn" id="btn-step-back">
          <span class="btn-icon">⏮</span>
        </button>
        <button class="anim-btn" id="btn-step-forward">
          <span class="btn-icon">⏭</span>
        </button>
        <button class="anim-btn" id="btn-reset" title="Reset to Full Moon">
          <span class="btn-icon">↺</span> Reset
        </button>
        <div class="speed-control">
          <label for="speed-select">Speed:</label>
          <select id="speed-select">
            <option value="1">1x</option>
            <option value="5" selected>5x</option>
            <option value="10">10x</option>
          </select>
        </div>
        <button class="anim-btn" id="btn-challenges" style="margin-left: auto;">
          <span class="btn-icon">&#127919;</span> Challenges
        </button>
      </div>

      <!-- Phase presets -->
      <div class="controls-panel">
        <!-- Shadow Toggle -->
        <div class="toggle-row" style="margin-bottom: 1rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
          <label class="toggle-switch">
            <input type="checkbox" id="show-shadow-toggle">
            <span class="toggle-switch__track">
              <span class="toggle-switch__thumb"></span>
            </span>
            <span class="toggle-switch__label">Show Earth's Shadow</span>
          </label>
        </div>
        <div class="controls-row">
          <button class="phase-btn" data-angle="180">New Moon</button>
          <button class="phase-btn" data-angle="270">First Quarter</button>
          <button class="phase-btn" data-angle="0">Full Moon</button>
          <button class="phase-btn" data-angle="90">Third Quarter</button>
        </div>
      </div>

      <!-- Key insight -->
      <div class="insight-box">
        <strong>Key insight:</strong> The Sun always lights exactly half of the Moon.
        Phases show <em>how much of that lit half faces Earth</em> — it's geometry, not shadow.
        Earth's shadow only matters during lunar eclipses (rare!).
      </div>

      <div class="model-note">
        <strong>Model note:</strong> Geometry-only; not to scale; phases are about illumination, not shadow.
      </div>

      <!-- Cross-demo navigation -->
      <div class="demo-nav">
        <a href="../eclipse-geometry/" class="demo-nav-link">
          Continue to Eclipse Geometry →
          <span class="demo-nav-hint">Why don't eclipses happen every month?</span>
        </a>
      </div>

      <style>
        .demo-nav {
          margin-top: 1.5rem;
          text-align: center;
        }

        .demo-nav-link {
          display: inline-flex;
          flex-direction: column;
          align-items: center;
          gap: 0.25rem;
          padding: 0.75rem 1.5rem;
          background: var(--space-light);
          border: 1px solid var(--border-color);
          border-radius: 8px;
          color: var(--text-secondary);
          text-decoration: none;
          font-size: 0.9rem;
          transition: all 0.2s ease;
        }

        .demo-nav-link:hover {
          background: var(--space-medium);
          border-color: var(--cosmic-teal);
          color: var(--text-primary);
        }

        .demo-nav-hint {
          font-size: 0.75rem;
          opacity: 0.7;
        }
      </style>

      <!-- Screen reader announcements -->
      <div id="status-announce" aria-live="polite" aria-atomic="true" class="sr-only"></div>
    </div>
  </div>

  <script src="../_assets/astro-utils.js"></script>
  <script src="../_assets/demo-polish.js"></script>
  <script src="../_assets/starfield.js"></script>
  <script src="../_assets/challenge-engine.js"></script>
  <script src="moon-phases.js"></script>
</body>
</html>
